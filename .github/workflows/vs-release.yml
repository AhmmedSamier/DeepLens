name: Visual Studio Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-publish:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v1.0.2

    - name: Restore NuGet packages
      run: nuget restore visual-studio-extension/DeepLensVisualStudio/DeepLensVisualStudio/DeepLensVisualStudio.csproj -SolutionDirectory visual-studio-extension/DeepLensVisualStudio

    - name: Update VSIX Version
      shell: pwsh
      run: |
        $version = "${{ github.ref_name }}".TrimStart('v')
        $manifestPath = "visual-studio-extension/DeepLensVisualStudio/DeepLensVisualStudio/source.extension.vsixmanifest"
        [xml]$manifest = Get-Content $manifestPath
        $manifest.PackageManifest.Metadata.Identity.Version = $version
        $manifest.Save($manifestPath)
        Write-Host "Updated VSIX version to $version"

    - name: Build Extension
      run: msbuild visual-studio-extension/DeepLensVisualStudio/DeepLensVisualStudio/DeepLensVisualStudio.csproj /p:Configuration=Release /p:DeployExtension=false

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: visual-studio-extension/DeepLensVisualStudio/DeepLensVisualStudio/bin/Release/net472/DeepLensVisualStudio.vsix
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Publish to Visual Studio Marketplace
    - name: Publish to Visual Studio Marketplace
      uses: cezarypiatek/VsixPublisherAction@1.1
      with:
        extension-file: visual-studio-extension/DeepLensVisualStudio/DeepLensVisualStudio/bin/Release/net472/DeepLensVisualStudio.vsix
        publish-manifest-file: visual-studio-extension/DeepLensVisualStudio/DeepLensVisualStudio/publishManifest.json
        personal-access-code: ${{ secrets.VSCE_PAT }}
