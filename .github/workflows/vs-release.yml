name: Visual Studio Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-and-publish:
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v1.1

    - name: Restore NuGet packages
      run: nuget restore visual-studio-extension/DeepLensVisualStudio/DeepLensVisualStudio/DeepLensVisualStudio.csproj -SolutionDirectory visual-studio-extension/DeepLensVisualStudio

    - name: Update VSIX Version
      shell: pwsh
      run: |
        $version = "${{ github.ref_name }}".TrimStart('v')
        $manifestPath = "visual-studio-extension/DeepLensVisualStudio/DeepLensVisualStudio/source.extension.vsixmanifest"
        [xml]$manifest = Get-Content $manifestPath
        $manifest.PackageManifest.Metadata.Identity.Version = $version
        $manifest.Save($manifestPath)
        Write-Host "Updated VSIX version to $version"

    - name: Build Extension
      run: msbuild visual-studio-extension/DeepLensVisualStudio/DeepLensVisualStudio/DeepLensVisualStudio.csproj /p:Configuration=Release /p:DeployExtension=false

    - name: Setup VsixPublisher
      shell: pwsh
      run: |
        $vsPath = vswhere -latest -products * -requires Microsoft.Component.MSBuild -property installationPath
        Write-Host "Searching for VsixPublisher.exe in $vsPath"
        $publisher = Get-ChildItem -Path $vsPath -Filter "VsixPublisher.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
        if ($publisher) {
          $publisherDir = $publisher.DirectoryName
          Write-Host "Found VsixPublisher.exe at $publisherDir"
          echo "$publisherDir" >> $env:GITHUB_PATH
        } else {
          Write-Error "VsixPublisher.exe not found in $vsPath"
        }

    # Publish to Visual Studio Marketplace
    # Note: You must add VSCE_PAT to your repo secrets
    - name: Publish to Marketplace
      uses: mrluje/vs-marketplace-publisher@v2
      with:
        pat: ${{ secrets.VSCE_PAT }}
        manifestPath: visual-studio-extension/DeepLensVisualStudio/DeepLensVisualStudio/publishManifest.json
        vsixPath: visual-studio-extension/DeepLensVisualStudio/DeepLensVisualStudio/bin/Release/net472/DeepLensVisualStudio.vsix

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: visual-studio-extension/DeepLensVisualStudio/DeepLensVisualStudio/bin/Release/net472/DeepLensVisualStudio.vsix
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
