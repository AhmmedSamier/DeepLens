# Indexing Time Review

This note captures opportunities to reduce indexing time in the language server based on the current implementation.

## Top optimization opportunities

1. **Avoid `stat` on every indexed file during file discovery**
   - `processFileList()` currently calls `getFileSize()` for each file before adding the file item.
   - `getFileSize()` performs `fs.promises.stat()` with retry logic, which adds one extra filesystem syscall per file.
   - Recommendation: make `size` lazy/optional during initial indexing and fetch it only when needed (for ranking/UI details), or batch stat only for visible/search-result candidates.

2. **Reduce C# auto-generated probing cost**
   - Every `.cs` file triggers `isAutoGeneratedFile()`, which opens the file and reads up to 1024 bytes.
   - On large C# repositories this doubles disk I/O in phase 2 (discover + pre-read) before parsing even starts.
   - Recommendation: add a cheap filename/path pre-filter first (`*.g.cs`, `*.Designer.cs`, `obj/`, `Generated/`) and only read file headers when ambiguous.

3. **Reuse parser instances inside workers**
   - Worker threads process batches, but `TreeSitterParser.parseFile()` constructs a new parser for each file (`new this.ParserClass()`).
   - Recommendation: keep one parser instance per language per worker and only call `setLanguage()` when language changes. This removes high-frequency object creation and setup overhead.

4. **Increase/adapt worker-to-main message chunk sizes**
   - Worker code posts results in sub-batches of 10 files (`BATCH_SIZE = 10`), which increases `postMessage` overhead and event churn.
   - Recommendation: tune this batch size dynamically (e.g., 25-100 depending on file size/history) or send one message per assigned worker batch unless cancellation/progress granularity requires finer chunks.

5. **Avoid doing two full symbol passes when workspace symbols are expensive**
   - `indexSymbols()` runs `scanWorkspaceSymbols()` and worker-based file parsing in parallel with `Promise.all`.
   - When `executeWorkspaceSymbolProvider` is available and costly, this can duplicate symbol work and CPU pressure.
   - Recommendation: use heuristics:
     - if workspace symbol provider returns quickly/high coverage, skip or reduce worker parsing,
     - otherwise run worker parsing only.

6. **Make non-git fallback file listing faster**
   - If git listing fails, file discovery falls back to `findFiles("**/*", "{...}")` backed by `glob`.
   - Recommendation: consider `rg --files` (with ignore rules) or a faster walker for large monorepos; keep glob as compatibility fallback.

## Suggested rollout order

1. Parser reuse in workers (low risk, high payoff).
2. Remove/defer per-file `stat` calls.
3. C# generated-file pre-filter.
4. Batch/message tuning in workers.
5. Workspace-symbol vs worker-pass gating.
6. Fallback file walker replacement.

## How to validate impact

- Add phase-level timing metrics around:
  - file discovery,
  - pre-filtering,
  - worker parsing,
  - symbol publication.
- Compare P50/P95 indexing time on:
  - medium repo (~20k files),
  - large monorepo (>100k files),
  - C# heavy repo.
- Track CPU usage, message counts, and number of filesystem reads/stats.
